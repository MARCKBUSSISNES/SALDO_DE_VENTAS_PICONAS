<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Cierre de Caja - Las Piconas</title>
<style>
  :root{
    --bg:#0b0b0f;
    --line: rgba(255,255,255,.14);
    --text: rgba(255,255,255,.92);
    --muted: rgba(255,255,255,.62);
    --good:#2ecc71;
    --bad:#ff4d4f;
    --shadow: 0 20px 60px rgba(0,0,0,.45);
    --radius: 22px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    background:
      radial-gradient(1200px 700px at 20% 10%, rgba(255,255,255,.10), transparent 60%),
      radial-gradient(900px 600px at 80% 0%, rgba(255,255,255,.08), transparent 55%),
      radial-gradient(800px 500px at 60% 90%, rgba(255,255,255,.06), transparent 60%),
      var(--bg);
    color:var(--text);
    min-height:100vh;
  }

  .shell{max-width:1180px; margin:18px auto; padding:14px;}
  @media (max-width:420px){ .shell{padding:10px; margin:10px auto;} }

  .topbar{
    display:flex; align-items:center; justify-content:space-between; gap:14px;
    padding:14px 16px;
    border:1px solid var(--line);
    background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    backdrop-filter: blur(14px);
  }
  @media (max-width:720px){ .topbar{flex-direction:column; align-items:flex-start;} }

  .brand{display:flex; align-items:center; gap:14px;}
  .brand img{
    height:68px; width:auto; display:block;
    filter: drop-shadow(0 10px 18px rgba(0,0,0,.35));
  }
  @media (max-width:420px){ .brand img{height:60px;} }
  .brand .t1{font-weight:900; letter-spacing:.2px; font-size:16px}
  .brand .t2{font-size:12px; color:var(--muted); margin-top:3px; line-height:1.2}

  .actions{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end;}
  @media (max-width:720px){ .actions{width:100%; justify-content:flex-start;} }

  .btn{
    border:1px solid var(--line);
    background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
    color:var(--text);
    border-radius: 14px;
    padding:10px 12px;
    cursor:pointer;
    font-weight:800;
    transition: transform .08s ease, border-color .15s ease;
    user-select:none;
  }
  .btn:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.22)}
  .btn:active{transform: translateY(0px)}
  .btn.secondary{background: rgba(255,255,255,.06)}
  .btn.danger{border-color: rgba(255,77,79,.35); background: linear-gradient(180deg, rgba(255,77,79,.20), rgba(255,77,79,.08));}
  .btn.good{border-color: rgba(46,204,113,.35); background: linear-gradient(180deg, rgba(46,204,113,.18), rgba(46,204,113,.08));}

  .pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 10px; border-radius:999px;
    border:1px solid var(--line);
    background: rgba(255,255,255,.06);
    font-size:12px; color: rgba(255,255,255,.85);
    white-space:nowrap;
  }

  .grid{ margin-top:14px; display:grid; grid-template-columns: 1.2fr .8fr; gap:14px; }
  @media (max-width:980px){ .grid{grid-template-columns:1fr} }

  .card{
    border:1px solid var(--line);
    background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    backdrop-filter: blur(14px);
    overflow:hidden;
  }
  .card h3{
    margin:0; padding:14px 16px;
    font-size:14px; letter-spacing:.3px;
    border-bottom:1px solid var(--line);
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    flex-wrap:wrap;
  }
  .card .body{padding:14px 16px}

  .row{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  @media (max-width:640px){ .row{grid-template-columns:1fr} }

  .field label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
  .field input{
    width:100%; padding:12px 12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.16);
    outline:none;
    background: rgba(0,0,0,.20);
    color:var(--text);
    font-size:14px;
  }
  .field input::placeholder{color: rgba(255,255,255,.35)}
  .subtle{ font-size:12px; color:var(--muted); line-height:1.4; }

  .summary{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:10px; }
  @media (max-width:520px){ .summary{grid-template-columns:1fr} }

  .kpi{
    padding:12px; border-radius:18px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
  }
  .kpi .k{font-size:12px; color:var(--muted)}
  .kpi .v{font-size:18px; font-weight:900; margin-top:6px}
  .kpi.good .v{color:var(--good)}
  .kpi.bad .v{color:var(--bad)}

  .tableBox{
    border-radius:16px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.04);
    overflow:auto;
  }
  table{ width:100%; border-collapse:separate; border-spacing:0; min-width:720px; }
  th, td{ padding:10px 10px; font-size:12px; border-bottom:1px solid rgba(255,255,255,.10); white-space:nowrap; }
  th{ text-align:left; color: rgba(255,255,255,.75); background: rgba(255,255,255,.05); position:sticky; top:0; z-index:1; }

  .badge{
    display:inline-block; padding:4px 8px;
    border-radius:999px; font-size:11px; font-weight:900;
    border:1px solid rgba(255,255,255,.16);
    background: rgba(255,255,255,.06);
  }
  .badge.good{border-color: rgba(46,204,113,.35); color: var(--good)}
  .badge.bad{border-color: rgba(255,77,79,.35); color: var(--bad)}

  .linkbtn{
    padding:6px 10px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.16);
    background: rgba(255,255,255,.06);
    color: var(--text);
    cursor:pointer;
    font-weight:900;
    font-size:12px;
  }

  /* Modals */
  .modalWrap{
    position:fixed; inset:0;
    background: rgba(0,0,0,.55);
    display:none; align-items:center; justify-content:center;
    padding:16px; z-index:9999;
  }
  .modal{
    width:min(980px, 100%);
    border-radius: 22px;
    border:1px solid rgba(255,255,255,.16);
    background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
    box-shadow: var(--shadow);
    backdrop-filter: blur(16px);
    overflow:hidden;
    max-height: 92vh;
    display:flex; flex-direction:column;
  }
  .modal .mh{
    padding:14px 16px;
    border-bottom:1px solid rgba(255,255,255,.14);
    display:flex; justify-content:space-between; align-items:center; gap:10px;
    flex-wrap:wrap;
  }
  .modal .mh .title{font-weight:900}
  .modal .mb{padding:14px 16px; overflow:auto;}
  .modal .mf{
    padding:14px 16px;
    border-top:1px solid rgba(255,255,255,.14);
    display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
  }
  .bigLogo{ display:flex; justify-content:center; align-items:center; padding:10px 0 2px; }
  .bigLogo img{
    height:120px; width:auto;
    filter: drop-shadow(0 14px 28px rgba(0,0,0,.45));
  }
  @media (max-width:420px){ .bigLogo img{height:105px;} }
</style>
</head>
<body>
<div class="shell">
  <div class="topbar">
    <div class="brand">
      <img src="LOGO1.png" alt="LOGO1" onerror="this.style.display='none'">
      <div>
        <div class="t1">Tortillas de Harina Las Piconas</div>
        <div class="t2">Cierre de Caja • Cuadre Sistema vs Cajero (incluye Uber Eats y PedidosYa) • Imprime 2 tickets</div>
      </div>
    </div>
    <div class="actions">
      <span class="pill" id="nowPill">—</span>
      <button class="btn secondary" id="btnCompras">Compras (detalle)</button>
      <button class="btn secondary" id="btnOpenHistory">Historial</button>
      <button class="btn danger" id="btnReset">Limpiar</button>
      <button class="btn good" id="btnSavePrint">Guardar + Imprimir</button>
    </div>
  </div>

  <div class="grid">
    <!-- Captura -->
    <div class="card">
      <h3>
        Captura del cierre
        <span class="pill" id="comprasPill">Compras: Q0.00</span>
      </h3>
      <div class="body">
        <div class="row">
          <div class="field">
            <label>Cajero en turno</label>
            <input id="cajero" placeholder="Ej: JOSE MANUEL" autocomplete="off">
          </div>
          <div class="field">
            <label>Fecha del cierre</label>
            <input id="fecha" type="date">
            <div class="subtle">Registro por <b>cajero + fecha</b> (reimpresión exacta).</div>
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="row">
          <div class="card" style="background:rgba(255,255,255,.04); border-radius:18px">
            <h3 style="border-bottom:1px solid rgba(255,255,255,.10); border-radius:18px 18px 0 0;">
              Sistema (cierre)
              <span class="pill">Entrada A</span>
            </h3>
            <div class="body">
              <div class="row">
                <div class="field">
                  <label>Fondo inicial (fijo)</label>
                  <input id="sysFondo" type="number" inputmode="decimal" value="1070">
                </div>
                <div class="field">
                  <label>Efectivo (según cierre)</label>
                  <input id="sysEfectivoCierre" type="number" inputmode="decimal" placeholder="0.00">
                </div>
              </div>

              <div class="row">
                <div class="field">
                  <label>Tarjeta (según cierre)</label>
                  <input id="sysTarjeta" type="number" inputmode="decimal" placeholder="0.00">
                </div>
                <div class="field">
                  <label>Uber Eats (según cierre)</label>
                  <input id="sysUber" type="number" inputmode="decimal" placeholder="0.00">
                </div>
              </div>

              <div class="row">
                <div class="field">
                  <label>PedidosYa (según cierre)</label>
                  <input id="sysPedidos" type="number" inputmode="decimal" placeholder="0.00">
                </div>
                <div class="field">
                  <label>Total compras (auto)</label>
                  <input id="sysComprasTotal" type="number" inputmode="decimal" placeholder="0.00" disabled>
                </div>
              </div>

              <div class="subtle">
                <b>Esperado en caja</b> = Efectivo cierre + Fondo inicial ± Compras (las compras se detallan y se imprimen)
              </div>
              <div class="subtle" style="margin-top:6px">
                Si tus compras son <b>GASTOS</b>, deben restar. Si son <b>REINTEGROS/ENTRADAS</b>, deben sumar.
                (Abajo hay un switch para esto.)
              </div>

              <div style="height:8px"></div>
              <div class="row">
                <div class="field">
                  <label>Modo compras</label>
                  <input id="modoCompras" value="GASTOS (restan)" disabled>
                  <div class="subtle">
                    <button class="linkbtn" id="btnToggleCompras" type="button">Cambiar a ENTRADAS / GASTOS</button>
                  </div>
                </div>
                <div class="field">
                  <label>&nbsp;</label>
                  <input value="(Se aplica al esperado)" disabled>
                </div>
              </div>
            </div>
          </div>

          <div class="card" style="background:rgba(255,255,255,.04); border-radius:18px">
            <h3 style="border-bottom:1px solid rgba(255,255,255,.10); border-radius:18px 18px 0 0;">
              Cajero (reporte)
              <span class="pill">Entrada B</span>
            </h3>
            <div class="body">
              <div class="row">
                <div class="field">
                  <label>Total en caja (efectivo físico)</label>
                  <input id="cjTotalCaja" type="number" inputmode="decimal" placeholder="0.00">
                </div>
                <div class="field">
                  <label>Ventas en efectivo (según cajero)</label>
                  <input id="cjEfectivo" type="number" inputmode="decimal" placeholder="0.00">
                </div>
              </div>

              <div class="row">
                <div class="field">
                  <label>Tarjeta (según cajero)</label>
                  <input id="cjTarjeta" type="number" inputmode="decimal" placeholder="0.00">
                </div>
                <div class="field">
                  <label>Uber Eats (según cajero)</label>
                  <input id="cjUber" type="number" inputmode="decimal" placeholder="0.00">
                </div>
              </div>

              <div class="row">
                <div class="field">
                  <label>PedidosYa (según cajero)</label>
                  <input id="cjPedidos" type="number" inputmode="decimal" placeholder="0.00">
                </div>
                <div class="field">
                  <label>Fondo inicial (referencia)</label>
                  <input id="cjFondo" type="number" inputmode="decimal" value="1070">
                </div>
              </div>

              <div class="subtle">
                El “Total en caja” es lo que manda para faltante/sobrante.
                El resto es para cuadrar canales (tarjeta/uber/pedidos).
              </div>
            </div>
          </div>
        </div>

        <div style="height:12px"></div>
        <div class="subtle">
          ✅ Imprime 2 tickets: 1) Cierre completo con compras y cuadre por canal. 2) Ticket de <b>Depósito/Saldo efectivo</b> = Total caja − Fondo.
        </div>
      </div>
    </div>

    <!-- Resultado -->
    <div class="card">
      <h3>
        Resultado del cuadre
        <span class="pill">Epson TM-T20 • 80mm</span>
      </h3>
      <div class="body">
        <div class="summary">
          <div class="kpi" id="kpiEsperado">
            <div class="k">Esperado en caja</div>
            <div class="v" id="vEsperado">Q0.00</div>
          </div>
          <div class="kpi" id="kpiDif">
            <div class="k">Diferencia (Caja − Esperado)</div>
            <div class="v" id="vDif">Q0.00</div>
          </div>
          <div class="kpi" id="kpiDeposito">
            <div class="k">Saldo efectivo / Depósito</div>
            <div class="v" id="vDeposito">Q0.00</div>
          </div>
          <div class="kpi" id="kpiCompras">
            <div class="k">Compras total</div>
            <div class="v" id="vCompras">Q0.00</div>
          </div>
        </div>

        <div style="height:12px"></div>
        <div class="tableBox">
          <table>
            <thead>
              <tr>
                <th>Concepto</th>
                <th>Sistema</th>
                <th>Cajero</th>
                <th>Diferencia</th>
              </tr>
            </thead>
            <tbody id="tbodyCompare"></tbody>
          </table>
        </div>

        <div style="height:12px"></div>
        <div class="subtle" id="statusLine">—</div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Compras -->
<div class="modalWrap" id="comprasWrap">
  <div class="modal">
    <div class="mh">
      <div class="title">Compras (detalle compra por compra)</div>
      <button class="btn secondary" id="btnCloseCompras">Cerrar</button>
    </div>
    <div class="mb">
      <div class="bigLogo">
        <img src="LOGO1.png" alt="LOGO1" onerror="this.style.display='none'">
      </div>

      <div class="row">
        <div class="field">
          <label>Descripción</label>
          <input id="compDesc" placeholder="Ej: gas, hielo, verdura..." autocomplete="off">
        </div>
        <div class="field">
          <label>Monto (Q)</label>
          <input id="compMonto" type="number" inputmode="decimal" placeholder="0.00">
        </div>
      </div>

      <div style="height:10px"></div>
      <button class="btn good" id="btnAddCompra" type="button">Agregar compra</button>

      <div style="height:12px"></div>
      <div class="tableBox">
        <table style="min-width:560px">
          <thead>
            <tr>
              <th>#</th>
              <th>Descripción</th>
              <th>Monto</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tbodyCompras"></tbody>
        </table>
      </div>

      <div style="height:10px"></div>
      <div class="subtle"><b>Total compras:</b> <span id="comprasTotalTxt">Q0.00</span></div>
    </div>

    <div class="mf">
      <button class="btn danger" id="btnClearCompras" type="button">Borrar compras</button>
    </div>
  </div>
</div>

<!-- Modal Historial -->
<div class="modalWrap" id="modalWrap">
  <div class="modal">
    <div class="mh">
      <div class="title">Historial (por cajero y fecha)</div>
      <button class="btn secondary" id="btnCloseModal">Cerrar</button>
    </div>
    <div class="mb">
      <div class="row">
        <div class="field">
          <label>Filtrar por cajero</label>
          <input id="fCajero" placeholder="Ej: JOSE" autocomplete="off">
        </div>
        <div class="field">
          <label>Filtrar por fecha</label>
          <input id="fFecha" type="date">
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="tableBox">
        <table>
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Cajero</th>
              <th>Esperado</th>
              <th>Caja</th>
              <th>Diferencia</th>
              <th>Depósito</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tbodyHist"></tbody>
        </table>
      </div>
    </div>
    <div class="mf">
      <button class="btn danger" id="btnClearHistory" type="button">Borrar historial</button>
      <button class="btn good" id="btnExportJson" type="button">Exportar JSON</button>
    </div>
  </div>
</div>

<script>
  const $ = (id)=>document.getElementById(id);
  const EMPRESA = "Tortillas de Harina Las Piconas";
  const STORE_KEY = "LP_CIERRES_V3";

  // comprasMode: "GASTOS" => restan; "ENTRADAS" => suman
  let comprasMode = "GASTOS";

  function toMoney(n){ n = Number(n||0); return "Q" + n.toFixed(2); }
  function num(el){ return Number((el.value||"").toString().replace(",",".")) || 0; }

  function todayYmd(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${dd}`;
  }
  function nowNice(){ return new Date().toLocaleString(); }

  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function tickNow(){ $("nowPill").textContent = nowNice(); }

  // ===== Compras por cajero+fecha =====
  function comprasKey(){
    const caj = ($("cajero").value||"").trim().toUpperCase();
    const fec = $("fecha").value || todayYmd();
    return "LP_COMPRAS|" + caj + "|" + fec;
  }
  function loadCompras(){ return JSON.parse(localStorage.getItem(comprasKey()) || "[]"); }
  function saveCompras(arr){ localStorage.setItem(comprasKey(), JSON.stringify(arr)); }
  function comprasTotal(arr){ return arr.reduce((a,x)=> a + Number(x.monto||0), 0); }

  function renderCompras(){
    const arr = loadCompras();
    const tb = $("tbodyCompras");
    tb.innerHTML = "";
    arr.forEach((c,i)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${escapeHtml(c.desc||"")}</td>
        <td>${toMoney(c.monto)}</td>
        <td><button class="linkbtn" data-i="${i}" type="button">Eliminar</button></td>
      `;
      tb.appendChild(tr);
    });
    tb.querySelectorAll("button[data-i]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const i = Number(b.getAttribute("data-i"));
        const a = loadCompras();
        a.splice(i,1);
        saveCompras(a);
        renderCompras();
        compute();
      });
    });

    const tot = comprasTotal(arr);
    $("comprasTotalTxt").textContent = toMoney(tot);
    $("sysComprasTotal").value = tot.toFixed(2);
    $("comprasPill").textContent = "Compras: " + toMoney(tot);
  }

  // ===== Cálculos =====
  function compute(){
    const compras = loadCompras();
    const comprasTot = comprasTotal(compras);

    const sys = {
      fondo: num($("sysFondo")),
      efectivo: num($("sysEfectivoCierre")),
      tarjeta: num($("sysTarjeta")),
      uber: num($("sysUber")),
      pedidos: num($("sysPedidos"))
    };

    const cj = {
      caja: num($("cjTotalCaja")),
      efectivo: num($("cjEfectivo")),
      tarjeta: num($("cjTarjeta")),
      uber: num($("cjUber")),
      pedidos: num($("cjPedidos")),
      fondoRef: num($("cjFondo"))
    };

    // compras impacta el esperado
    const comprasImpacto = (comprasMode === "GASTOS") ? -comprasTot : +comprasTot;

    // Esperado en caja (lo que debería haber físicamente)
    const esperado = sys.fondo + sys.efectivo + comprasImpacto;

    // Diferencia caja
    const dif = cj.caja - esperado;

    // Depósito / saldo efectivo: lo que se deposita al banco (caja - fondo)
    // Usamos el fondo del SISTEMA porque ese es el fijo real.
    const deposito = cj.caja - sys.fondo;

    // KPIs
    $("vEsperado").textContent = toMoney(esperado);
    $("vDif").textContent = toMoney(dif);
    $("vDeposito").textContent = toMoney(deposito);
    $("vCompras").textContent = toMoney(comprasTot);

    // Color KPI diferencia
    const kpiDif = $("kpiDif");
    kpiDif.classList.remove("good","bad");
    if (Math.abs(dif) < 0.01) kpiDif.classList.add("good");
    else if (dif < 0) kpiDif.classList.add("bad");
    else kpiDif.classList.add("good");

    // Estado
    let estado = "CUADRADO";
    if (Math.abs(dif) >= 0.01) estado = (dif < 0 ? "FALTANTE" : "SOBRANTE");

    // Tabla de cuadre (incluye Uber/Pedidos y Tarjeta)
    const rows = [
      {k:"Efectivo (cierre vs cajero)", a: sys.efectivo, b: cj.efectivo},
      {k:"Tarjeta (cierre vs cajero)", a: sys.tarjeta, b: cj.tarjeta},
      {k:"Uber Eats (cierre vs cajero)", a: sys.uber, b: cj.uber},
      {k:"PedidosYa (cierre vs cajero)", a: sys.pedidos, b: cj.pedidos},
      {k:`Compras (${comprasMode})`, a: comprasImpacto, b: comprasImpacto},
      {k:"Fondo inicial (fijo)", a: sys.fondo, b: sys.fondo},
      {k:"TOTAL ESPERADO EN CAJA", a: esperado, b: esperado},
      {k:"TOTAL EN CAJA (cajero)", a: 0, b: cj.caja},
      {k:"SALDO/DEPÓSITO (Caja − Fondo)", a: 0, b: deposito},
    ];

    const tb = $("tbodyCompare");
    tb.innerHTML = "";
    rows.forEach(r=>{
      const d = (r.b - r.a);
      const cls = (Math.abs(d) < 0.01) ? "good" : (d < 0 ? "bad" : "good");
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(r.k)}</td>
        <td>${toMoney(r.a)}</td>
        <td>${toMoney(r.b)}</td>
        <td><span class="badge ${cls}">${toMoney(d)}</span></td>
      `;
      tb.appendChild(tr);
    });

    $("sysComprasTotal").value = comprasTot.toFixed(2);
    $("comprasPill").textContent = "Compras: " + toMoney(comprasTot);

    $("statusLine").innerHTML =
      `Estado: <b>${estado}</b>. (Caja − Esperado) • Depósito recomendado: <b>${toMoney(deposito)}</b>`;

    return {sys, cj, compras, comprasTot, comprasMode, comprasImpacto, esperado, dif, deposito, estado};
  }

  // ===== Guardado historial =====
  function keyOf(cajero, fecha){ return (cajero||"").trim().toUpperCase() + "|" + fecha; }
  function loadAll(){ return JSON.parse(localStorage.getItem(STORE_KEY) || "[]"); }
  function saveAll(arr){ localStorage.setItem(STORE_KEY, JSON.stringify(arr)); }
  function upsertRecord(rec){
    const all = loadAll();
    const idx = all.findIndex(x=>x.key===rec.key);
    if (idx>=0) all[idx]=rec; else all.unshift(rec);
    saveAll(all);
  }

  // ===== Tickets =====
  function buildTicketCierre(rec){
    const d = rec;
    const comprasLines = d.compras.length
      ? d.compras.map(x=>`<tr><td>${escapeHtml(x.desc)}</td><td class="r">${toMoney(x.monto)}</td></tr>`).join("")
      : `<tr><td colspan="2">Sin compras registradas</td></tr>`;

    const comprasLabel = (d.comprasMode === "GASTOS") ? "GASTOS (restan)" : "ENTRADAS (suman)";
    const comprasSigned = d.comprasImpacto; // ya viene con signo (+/-)

    return `
<!doctype html>
<html><head><meta charset="utf-8"/>
<title>Ticket Cierre</title>
<style>
  @page{ margin: 6mm; }
  body{ font-family: monospace; width: 80mm; margin:0; }
  .c{text-align:center}
  .hr{border-top:1px dashed #000; margin:6px 0}
  img{ max-width: 72mm; height:auto; }
  .b{font-weight:700}
  .r{text-align:right}
  table{ width:100%; border-collapse:collapse; }
  td{ padding:2px 0; vertical-align:top; }
  .small{font-size:11px}
</style>
</head><body>
  <div class="c">
    <img src="LOGO1.png" onerror="this.style.display='none'"><br>
    <div class="b">${escapeHtml(EMPRESA)}</div>
    <div class="small">CIERRE DE CAJA</div>
  </div>

  <div class="hr"></div>
  <div>Cajero: <span class="b">${escapeHtml(d.cajero)}</span></div>
  <div>Fecha: ${escapeHtml(d.fecha)}</div>
  <div>Guardado: ${escapeHtml(d.guardadoEn)}</div>

  <div class="hr"></div>
  <div class="b">CUADRE POR CANAL</div>
  <table>
    <tr><td>Efectivo (cierre)</td><td class="r">${toMoney(d.sys.efectivo)}</td></tr>
    <tr><td>Efectivo (cajero)</td><td class="r">${toMoney(d.cj.efectivo)}</td></tr>
    <tr><td>Tarjeta (cierre)</td><td class="r">${toMoney(d.sys.tarjeta)}</td></tr>
    <tr><td>Tarjeta (cajero)</td><td class="r">${toMoney(d.cj.tarjeta)}</td></tr>
    <tr><td>Uber Eats (cierre)</td><td class="r">${toMoney(d.sys.uber)}</td></tr>
    <tr><td>Uber Eats (cajero)</td><td class="r">${toMoney(d.cj.uber)}</td></tr>
    <tr><td>PedidosYa (cierre)</td><td class="r">${toMoney(d.sys.pedidos)}</td></tr>
    <tr><td>PedidosYa (cajero)</td><td class="r">${toMoney(d.cj.pedidos)}</td></tr>
  </table>

  <div class="hr"></div>
  <div class="b">EFECTIVO EN CAJA</div>
  <table>
    <tr><td>Fondo inicial</td><td class="r">${toMoney(d.sys.fondo)}</td></tr>
    <tr><td>Efectivo (cierre)</td><td class="r">${toMoney(d.sys.efectivo)}</td></tr>
    <tr><td>Compras (${escapeHtml(comprasLabel)})</td><td class="r">${toMoney(comprasSigned)}</td></tr>
    <tr><td class="b">TOTAL ESPERADO</td><td class="r b">${toMoney(d.esperado)}</td></tr>
    <tr><td class="b">TOTAL EN CAJA (cajero)</td><td class="r b">${toMoney(d.cj.caja)}</td></tr>
  </table>

  <div class="hr"></div>
  <table>
    <tr><td class="b">DIFERENCIA (Caja − Esperado)</td><td class="r b">${toMoney(d.dif)}</td></tr>
    <tr><td class="b">ESTADO</td><td class="r b">${escapeHtml(d.estado)}</td></tr>
  </table>

  <div class="hr"></div>
  <div class="b">COMPRAS (DETALLE)</div>
  <table>${comprasLines}</table>

  <div class="hr"></div>
  <div class="c small">80mm • Epson TM-T20</div>
</body></html>`;
  }

  function buildTicketDeposito(rec){
    const d = rec;
    return `
<!doctype html>
<html><head><meta charset="utf-8"/>
<title>Ticket Depósito</title>
<style>
  @page{ margin: 6mm; }
  body{ font-family: monospace; width: 80mm; margin:0; }
  .c{text-align:center}
  .hr{border-top:1px dashed #000; margin:6px 0}
  img{ max-width: 72mm; height:auto; }
  .b{font-weight:700}
  .r{text-align:right}
  table{ width:100%; border-collapse:collapse; }
  td{ padding:2px 0; vertical-align:top; }
  .small{font-size:11px}
</style>
</head><body>
  <div class="c">
    <img src="LOGO1.png" onerror="this.style.display='none'"><br>
    <div class="b">${escapeHtml(EMPRESA)}</div>
    <div class="small">SALDO EFECTIVO / DEPÓSITO</div>
  </div>

  <div class="hr"></div>
  <div>Cajero: <span class="b">${escapeHtml(d.cajero)}</span></div>
  <div>Fecha: ${escapeHtml(d.fecha)}</div>

  <div class="hr"></div>
  <table>
    <tr><td>Total en caja (cajero)</td><td class="r">${toMoney(d.cj.caja)}</td></tr>
    <tr><td>Fondo inicial (se queda)</td><td class="r">-${toMoney(d.sys.fondo).replace("Q","Q")}</td></tr>
    <tr><td class="b">SALDO / DEPÓSITO</td><td class="r b">${toMoney(d.deposito)}</td></tr>
  </table>

  <div class="hr"></div>
  <div class="small">
    Nota: El fondo inicial no se mueve. El saldo es lo que corresponde a ventas en efectivo.
  </div>

  <div class="hr"></div>
  <div class="c small">80mm • Epson TM-T20</div>
</body></html>`;
  }

  function printHTML(html){
    const w = window.open("", "", "width=380,height=740");
    w.document.open();
    w.document.write(html);
    w.document.close();
    setTimeout(()=>{ w.focus(); w.print(); }, 350);
  }

  // ===== Acciones =====
  function saveAndPrint(){
    const caj = ($("cajero").value||"").trim();
    const fec = $("fecha").value;
    if (!caj){ alert("Escribe el nombre del cajero."); $("cajero").focus(); return; }
    if (!fec){ alert("Selecciona la fecha del cierre."); $("fecha").focus(); return; }

    const calc = compute();
    const rec = {
      key: keyOf(caj, fec),
      cajero: caj.toUpperCase(),
      fecha: fec,
      guardadoEn: nowNice(),
      sys: calc.sys,
      cj: calc.cj,
      compras: calc.compras,
      comprasTot: calc.comprasTot,
      comprasMode: calc.comprasMode,
      comprasImpacto: calc.comprasImpacto,
      esperado: calc.esperado,
      dif: calc.dif,
      deposito: calc.deposito,
      estado: calc.estado
    };
    upsertRecord(rec);

    // Ticket 1: Cierre completo
    printHTML(buildTicketCierre(rec));

    // Ticket 2: Depósito
    setTimeout(()=>{ printHTML(buildTicketDeposito(rec)); }, 700);
  }

  function resetFields(){
    const keepDate = $("fecha").value || todayYmd();
    const caj = $("cajero").value;
    $("sysFondo").value = "1070";
    $("sysEfectivoCierre").value = "";
    $("sysTarjeta").value = "";
    $("sysUber").value = "";
    $("sysPedidos").value = "";

    $("cjTotalCaja").value = "";
    $("cjEfectivo").value = "";
    $("cjTarjeta").value = "";
    $("cjUber").value = "";
    $("cjPedidos").value = "";
    $("cjFondo").value = "1070";

    $("fecha").value = keepDate;
    $("cajero").value = caj;

    compute();
  }

  // ===== Historial =====
  function openHistory(){ $("modalWrap").style.display="flex"; renderHistory(); }
  function closeHistory(){ $("modalWrap").style.display="none"; }

  function renderHistory(){
    const all = loadAll();
    const fC = ($("fCajero").value||"").trim().toUpperCase();
    const fF = $("fFecha").value;

    const filtered = all.filter(r=>{
      const okC = !fC || (r.cajero||"").toUpperCase().includes(fC);
      const okF = !fF || r.fecha === fF;
      return okC && okF;
    });

    const tb = $("tbodyHist");
    tb.innerHTML = "";
    filtered.forEach(r=>{
      const cls = (Math.abs(r.dif) < 0.01) ? "good" : (r.dif < 0 ? "bad" : "good");
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(r.fecha)}</td>
        <td>${escapeHtml(r.cajero)}</td>
        <td>${toMoney(r.esperado)}</td>
        <td>${toMoney(r.cj?.caja ?? 0)}</td>
        <td><span class="badge ${cls}">${toMoney(r.dif)}</span></td>
        <td>${toMoney(r.deposito ?? 0)}</td>
        <td><span class="badge ${cls}">${escapeHtml(r.estado||"")}</span></td>
        <td>
          <button class="linkbtn" data-act="print1" data-key="${escapeHtml(r.key)}" type="button">Imprimir cierre</button>
          <button class="linkbtn" data-act="print2" data-key="${escapeHtml(r.key)}" type="button">Imprimir depósito</button>
        </td>
      `;
      tb.appendChild(tr);
    });

    tb.querySelectorAll("button[data-act]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const act = b.getAttribute("data-act");
        const key = b.getAttribute("data-key");
        const rec = loadAll().find(x=>x.key===key);
        if (!rec) return;
        if (act==="print1") printHTML(buildTicketCierre(rec));
        if (act==="print2") printHTML(buildTicketDeposito(rec));
      });
    });
  }

  function clearHistory(){
    if (!confirm("¿Borrar TODO el historial guardado en este navegador?")) return;
    localStorage.removeItem(STORE_KEY);
    renderHistory();
  }

  function exportJson(){
    const data = JSON.stringify(loadAll(), null, 2);
    const blob = new Blob([data], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "cierres_las_piconas_v3.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // ===== Compras modal =====
  function openCompras(){ $("comprasWrap").style.display="flex"; renderCompras(); }
  function closeCompras(){ $("comprasWrap").style.display="none"; }

  function addCompra(){
    const desc = ($("compDesc").value||"").trim();
    const monto = Number($("compMonto").value||0);
    if (!desc){ alert("Escribe la descripción de la compra."); $("compDesc").focus(); return; }
    if (!(monto>0)){ alert("Ingresa un monto mayor a 0."); $("compMonto").focus(); return; }
    const arr = loadCompras();
    arr.push({desc, monto});
    saveCompras(arr);
    $("compDesc").value = "";
    $("compMonto").value = "";
    renderCompras();
    compute();
  }

  function clearCompras(){
    if (!confirm("¿Borrar todas las compras del cajero/fecha actual?")) return;
    saveCompras([]);
    renderCompras();
    compute();
  }

  // ===== Compras mode toggle =====
  function setComprasModeUI(){
    $("modoCompras").value = (comprasMode === "GASTOS") ? "GASTOS (restan)" : "ENTRADAS (suman)";
  }
  function toggleComprasMode(){
    comprasMode = (comprasMode === "GASTOS") ? "ENTRADAS" : "GASTOS";
    setComprasModeUI();
    compute();
  }

  // ===== init =====
  function loadAll(){ return JSON.parse(localStorage.getItem(STORE_KEY) || "[]"); }

  $("fecha").value = todayYmd();
  setInterval(tickNow, 1000); tickNow();

  // Live compute
  [
    "sysFondo","sysEfectivoCierre","sysTarjeta","sysUber","sysPedidos",
    "cjTotalCaja","cjEfectivo","cjTarjeta","cjUber","cjPedidos","cjFondo"
  ].forEach(id=> $(id).addEventListener("input", compute));

  $("btnSavePrint").addEventListener("click", saveAndPrint);
  $("btnReset").addEventListener("click", resetFields);

  $("btnCompras").addEventListener("click", openCompras);
  $("btnCloseCompras").addEventListener("click", closeCompras);
  $("comprasWrap").addEventListener("click",(e)=>{ if(e.target===$("comprasWrap")) closeCompras(); });
  $("btnAddCompra").addEventListener("click", addCompra);
  $("btnClearCompras").addEventListener("click", clearCompras);

  $("btnOpenHistory").addEventListener("click", openHistory);
  $("btnCloseModal").addEventListener("click", closeHistory);
  $("modalWrap").addEventListener("click",(e)=>{ if(e.target===$("modalWrap")) closeHistory(); });
  $("btnClearHistory").addEventListener("click", clearHistory);
  $("btnExportJson").addEventListener("click", exportJson);
  $("fCajero").addEventListener("input", renderHistory);
  $("fFecha").addEventListener("change", renderHistory);

  $("btnToggleCompras").addEventListener("click", toggleComprasMode);

  setComprasModeUI();
  renderCompras();
  compute();
</script>
</body>
</html>
